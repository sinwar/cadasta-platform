import re
from bs4 import BeautifulSoup
from django.utils.translation import ugettext as _

from jsonschema import Draft4Validator, FormatChecker
from .exceptions import JsonValidationError


def validate_json(value, schema):
    v = Draft4Validator(schema, format_checker=FormatChecker())
    errors = sorted(v.iter_errors(value), key=lambda e: e.path)

    message_dict = {}
    for e in errors:
        if e.validator == 'anyOf':
            fields = [
                f.message.split(' ')[0].replace('\'', '') for f in e.context
            ]

            for f in fields:
                message_dict[f] = _("Please provide either {}").format(
                    _(" or ").join(fields))

        elif e.validator == 'required':
            field = e.message.split(' ')[0].replace('\'', '')
            message_dict[field] = _("This field is required.")
        else:
            field = '.'.join([str(el) for el in e.path])
            message_dict[field] = e.message

    if message_dict:
        raise JsonValidationError(message_dict)


emojis = re.compile(u'.*[\U0001F300-\U0001F64F\U0001F680-\U0001F6FF'
                    u'\u2600-\u26FF\u2700-\u27BF].*')
macros = re.compile('^[' + re.escape('-=+@') + ']')


def sanitize_string(value):
    if not value or not isinstance(value, str):
        return True

    return (not bool(BeautifulSoup(value, 'html.parser').find()) and
            not emojis.match(value) and
            not macros.match(value))
